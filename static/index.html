<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUM - Universal Knowledge Engine</title>
    <style>
        :root {
            --primary: #2196F3;
            --secondary: #4CAF50;
            --bg: #f5f5f5;
            --card-bg: white;
            --text: #333;
            --log-color: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s;
        }
        
        .container {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin: 0 0 10px 0;
            font-size: 2.5em;
            letter-spacing: -1px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-weight: 300;
            font-size: 1.1em;
        }
        
        .philosophical-quote {
            text-align: center;
            font-style: italic;
            color: #888;
            font-size: 0.9em;
            margin-bottom: 30px;
            padding: 0 40px;
            line-height: 1.5;
        }

        .input-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .tab {
            padding: 8px 16px;
            background: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            color: #666;
        }
        
        .tab.active {
            background: #333;
            color: white;
        }
        
        .input-section {
            display: none;
        }
        
        .input-section.active {
            display: block;
        }
        
        textarea {
            width: 100%;
            height: 150px;
            padding: 20px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 16px;
            resize: vertical;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            background: #fafafa;
            border-color: #bbb;
        }
        
        /* THE UNIVERSAL SLIDER */
        .spectrum-container {
            margin: 40px 0;
            padding: 30px 20px;
            background: linear-gradient(to right, rgba(76, 175, 80, 0.05), rgba(33, 150, 243, 0.05));
            border-radius: 16px;
            position: relative;
        }
        
        .spectrum-label {
            text-align: center;
            font-weight: 600;
            margin-bottom: 25px;
            font-size: 1.2em;
            color: #444;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .spectrum-icon {
            font-size: 1.5em;
        }
        
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: linear-gradient(to right, var(--secondary), var(--primary));
            outline: none;
            border-radius: 4px;
            margin: 0;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 2px solid #333;
            transition: transform 0.1s;
        }
        
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        
        .spectrum-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            position: relative;
        }
        
        .marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 60px;
            transition: all 0.3s;
            opacity: 0.5;
        }
        
        .marker.active {
            opacity: 1;
            transform: translateY(-2px);
        }
        
        .marker-dot {
            width: 4px;
            height: 4px;
            background: #333;
            border-radius: 50%;
            margin-bottom: 8px;
        }
        
        .marker-label {
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
        }
        
        .marker-desc {
            font-size: 0.7em;
            color: #888;
            margin-top: 2px;
        }
        
        /* Action Button */
        button.action-btn {
            background: #333;
            color: white;
            border: none;
            padding: 18px 36px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        button.action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        
        button.action-btn:disabled {
            background: #ccc;
            transform: none;
            box-shadow: none;
        }
        
        /* Dynamic Button Gradients */
        button.action-btn.distill {
            background: var(--secondary);
        }
        
        button.action-btn.expand {
            background: var(--primary);
        }
        
        /* Results */
        .result {
            margin-top: 40px;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-card {
            padding: 25px;
            background: #fff;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            line-height: 1.6;
        }
        
        .result-label {
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tag {
            background: #f0f7f0;
            color: #2e7d32;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid #e0e0e0;
        }
        
        .loading {
            text-align: center;
            display: none;
            padding: 40px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #333;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        
        /* Live Logs for Book Generation */
        .system-log {
            font-family: monospace;
            font-size: 0.85em;
            color: var(--log-color);
            border-left: 2px solid #ddd;
            padding-left: 10px;
            margin: 5px 0;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-5px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>SUM</h1>
        <p class="subtitle">Universal Knowledge Engine</p>
        
        <p class="philosophical-quote">
            "Depending on the author, a million books can be distilled into a single sentence, 
            and a single sentence can conceal a million books."
        </p>
        
        <div class="input-tabs">
            <button class="tab active" onclick="switchTab('text')">Text</button>
            <button class="tab" onclick="switchTab('file')">File</button>
        </div>
        
        <div id="text-input" class="input-section active">
            <textarea id="input-text" placeholder="Enter anything: a word, a sentence, an article, or a book..."></textarea>
        </div>
        
        <div id="file-input" class="input-section">
            <div class="file-upload" id="file-drop">
                <input type="file" id="file-select" accept="*" style="display: none;">
                <p style="font-size: 32px; margin: 0 0 10px 0;">üìÅ</p>
                <p style="margin: 0;">Drop file or click to upload</p>
                <div id="file-info" style="margin-top: 10px; font-weight: bold; color: var(--primary);"></div>
            </div>
        </div>
        
        <!-- THE UNIVERSAL SPECTRUM -->
        <div class="spectrum-container">
            <div class="spectrum-label">
                <span id="spectrum-icon" class="spectrum-icon">‚ö°</span>
                <span id="spectrum-text">Target Density</span>
            </div>
            
            <input type="range" min="0" max="5" value="2" step="1" id="spectrum-slider" oninput="updateSpectrum(this.value)">
            
            <div class="spectrum-markers">
                <div class="marker" onclick="setSpectrum(0)">
                    <div class="marker-dot"></div>
                    <div class="marker-label">Tags</div>
                    <div class="marker-desc">Atoms</div>
                </div>
                <div class="marker" onclick="setSpectrum(1)">
                    <div class="marker-dot"></div>
                    <div class="marker-label">SUM</div>
                    <div class="marker-desc">Essence</div>
                </div>
                <div class="marker active" onclick="setSpectrum(2)">
                    <div class="marker-dot"></div>
                    <div class="marker-label">Short</div>
                    <div class="marker-desc">Thought</div>
                </div>
                <div class="marker" onclick="setSpectrum(3)">
                    <div class="marker-dot"></div>
                    <div class="marker-label">Article</div>
                    <div class="marker-desc">Context</div>
                </div>
                <div class="marker" onclick="setSpectrum(4)">
                    <div class="marker-dot"></div>
                    <div class="marker-label">Essay</div>
                    <div class="marker-desc">Deep</div>
                </div>
                <div class="marker" onclick="setSpectrum(5)">
                    <div class="marker-dot"></div>
                    <div class="marker-label">Book</div>
                    <div class="marker-desc">Universe</div>
                </div>
            </div>
        </div>
        
        <button id="action-btn" class="action-btn" onclick="process()">Transform</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loading-status">Transforming knowledge...</p>
        </div>
        
        <div class="result" id="result">
            <!-- This is where results go -->
            <div id="result-content"></div>
        </div>
    </div>
    
    <script>
        // Configuration
        const LEVELS = [
            { id: 'tags', label: 'Tags', icon: 'üè∑Ô∏è', action: 'Distill', type: 'summarize', target_words: 20 },
            { id: 'minimal', label: 'SUM', icon: 'üíß', action: 'Distill', type: 'summarize', target_words: 50 },
            { id: 'short', label: 'Paragraph', icon: 'üìù', action: 'Transform', type: 'hybrid', target_words: 200 },
            { id: 'article', label: 'Article', icon: 'üìÑ', action: 'Transform', type: 'hybrid', target_words: 800 },
            { id: 'essay', label: 'Essay', icon: 'üìö', action: 'Expand', type: 'extrapolate', target_words: 2500 },
            { id: 'book', label: 'Book', icon: 'ü™ê', action: 'Create', type: 'extrapolate', target_words: 20000 }
        ];

        let currentTab = 'text';
        let selectedFile = null;
        
        // Init
        updateSpectrum(2);
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.input-section').forEach(s => s.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`${tab}-input`).classList.add('active');
        }

        function setSpectrum(val) {
            document.getElementById('spectrum-slider').value = val;
            updateSpectrum(val);
        }

        function updateSpectrum(val) {
            val = parseInt(val);
            const level = LEVELS[val];
            
            // Update UI Labels
            document.getElementById('spectrum-text').textContent = level.label;
            document.getElementById('spectrum-icon').textContent = level.icon;
            
            // Highlight marker
            document.querySelectorAll('.marker').forEach((m, i) => {
                m.classList.toggle('active', i === val);
            });
            
            // Dynamic Button Logic
            const btn = document.getElementById('action-btn');
            
            // Heuristic to guess intent based on slider position
            if (val <= 1) {
                btn.className = 'action-btn distill';
                btn.textContent = 'Distill';
            } else if (val >= 4) {
                btn.className = 'action-btn expand';
                btn.textContent = 'Expand';
            } else {
                btn.className = 'action-btn';
                btn.textContent = 'Transform';
            }
        }
        
        // File Handling
        const fileDropZone = document.getElementById('file-drop');
        const fileInput = document.getElementById('file-select');
        
        fileDropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                document.getElementById('file-info').textContent = selectedFile.name;
            }
        });

        // CORE LOGIC
        async function process() {
            const sliderVal = document.getElementById('spectrum-slider').value;
            const level = LEVELS[sliderVal];
            
            let inputText = '';
            let inputLength = 0;
            
            // Get Input
            if (currentTab === 'text') {
                inputText = document.getElementById('input-text').value.trim();
                if (!inputText) return alert('Please enter some text or upload a file.');
                inputLength = inputText.split(/\s+/).length;
            } else {
                if (!selectedFile) return alert('Please select a file.');
                inputLength = selectedFile.size / 6; // Rough bytes-to-words
            }
            
            // UI State
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('action-btn').disabled = true;
            document.getElementById('result-content').innerHTML = '';
            
            try {
                // DECISION ENGINE: Summarize vs Extrapolate
                let mode = 'summarize';
                
                // If "Book" or "Essay" -> Extrapolate
                if (level.id === 'book' || level.id === 'essay') {
                    mode = 'extrapolate';
                } 
                // If "Tags" or "Minimal" -> Summarize
                else if (level.id === 'tags' || level.id === 'minimal') {
                    mode = 'summarize';
                }
                // Middle ground: Check relative lengths
                else {
                    if (inputLength > level.target_words * 1.5) {
                        mode = 'summarize';
                    } else {
                        mode = 'extrapolate';
                    }
                }
                
                console.log(`Decision: ${mode} (Input: ${inputLength} words -> Target: ${level.id})`);
                
                if (mode === 'summarize') {
                    await performSummarization(inputText, level.id);
                } else {
                    await performExtrapolation(inputText, level.id, level.target_words);
                }
                
            } catch (e) {
                showError(e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('action-btn').disabled = false;
            }
        }
        
        async function performSummarization(text, density) {
            let response;
            
            const densityMap = {
                'tags': 'tags',
                'minimal': 'minimal',
                'short': 'short',
                'article': 'medium', 
                'essay': 'detailed',
                'book': 'all'
            };
            
            const apiDensity = densityMap[density] || 'medium';
            
            document.getElementById('result').style.display = 'block';
            const contentDiv = document.getElementById('result-content');
            contentDiv.innerHTML = '<div id="log-container" style="margin-bottom: 20px;"></div><div id="summary-output"></div>';

            const logContainer = document.getElementById('log-container');
            const summaryOutput = document.getElementById('summary-output');

            if (currentTab === 'file') {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('density', apiDensity);
                response = await fetch('/api/summarize/stream_unlimited', { method: 'POST', body: formData });
            } else {
                response = await fetch('/api/summarize/stream_unlimited', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text, density: apiDensity })
                });
            }
            
            if (!response.ok) throw new Error('Summarization failed');

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, {stream: true});
                const lines = buffer.split('

');
                buffer = lines.pop(); // keep the last incomplete chunk in the buffer

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const dataStr = line.slice(6);
                        if (dataStr === '[DONE]') continue;
                        try {
                            const json = JSON.parse(dataStr);
                            if (json.type === 'log') {
                                const logEntry = document.createElement('div');
                                logEntry.className = 'system-log';
                                logEntry.textContent = `> ${json.content}`;
                                logContainer.appendChild(logEntry);
                                // Auto scroll
                                window.scrollTo(0, document.body.scrollHeight);
                            } else if (json.type === 'result') {
                                displayResult(json.data, density);
                            } else if (json.type === 'error') {
                                showError(json.content);
                            }
                        } catch (e) {
                            console.error('Error parsing SSE', e, dataStr);
                        }
                    }
                }
            }
        }
        async function performExtrapolation(seedText, formatId, length) {
            // Streaming Extrapolation
            const response = await fetch('/api/extrapolate/stream', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    seed: seedText || (selectedFile ? selectedFile.name : "content"),
                    target_format: formatId,
                    length_words: length
                })
            });
            
            if (!response.ok) throw new Error('Extrapolation failed to start');
            
            document.getElementById('result').style.display = 'block';
            const contentDiv = document.getElementById('result-content');
            
            // Create result card for text
            contentDiv.innerHTML = '<div class="result-card" id="stream-output"></div>';
            const output = document.getElementById('stream-output');
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = '';
            
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value, {stream: true});
                const lines = chunk.split('\n\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(line.slice(6));
                            
                            // Handling Text
                            if (json.type === 'text' || json.chunk) {
                                fullText += (json.content || json.chunk);
                                output.innerHTML = formatText(fullText);
                                window.scrollTo(0, document.body.scrollHeight);
                            }
                            
                            // Handling Logs
                            if (json.type === 'log') {
                                // Prepend log to the top of result container (or separate log container)
                                let logDiv = document.getElementById('log-container');
                                if (!logDiv) {
                                    logDiv = document.createElement('div');
                                    logDiv.id = 'log-container';
                                    logDiv.style.marginBottom = '20px';
                                    contentDiv.insertBefore(logDiv, output);
                                }
                                const logEntry = document.createElement('div');
                                logEntry.className = 'system-log';
                                logEntry.textContent = `> ${json.content}`;
                                logDiv.appendChild(logEntry);
                            }
                            
                        } catch (e) {}
                    }
                }
            }
        }
        
        function displayResult(data, reqDensity) {
            const contentDiv = document.getElementById('result-content');
            contentDiv.innerHTML = '';
            document.getElementById('result').style.display = 'block';
            
            const result = data.result || data;
            
            // 1. Tags
            if (reqDensity === 'tags' || result.tags) {
                const tags = result.tags || (Array.isArray(result) ? result : []);
                if (tags.length > 0) {
                     contentDiv.innerHTML += `
                        <div class="result-card">
                            <div class="result-label">üè∑Ô∏è Crystallized Concepts</div>
                            <div class="tags">
                                ${tags.map(t => `<span class="tag">${t}</span>`).join('')}
                            </div>
                        </div>`;
                }
            }
            
            // 2. Text Summary
            let summaryText = '';
            if (reqDensity === 'minimal' && result.minimal) summaryText = result.minimal;
            else if (reqDensity === 'short' && result.short) summaryText = result.short;
            else if (reqDensity === 'article' && result.medium) summaryText = result.medium;
            else if (reqDensity === 'essay' && result.detailed) summaryText = result.detailed;
            else summaryText = result.summary || result.text || '';
            
            if (summaryText && reqDensity !== 'tags') {
                 contentDiv.innerHTML += `
                    <div class="result-card">
                        <div class="result-label">üìù Distilled Knowledge</div>
                        <div style="font-size: 1.1em; line-height: 1.6;">${formatText(summaryText)}</div>
                    </div>`;
            }
            
            document.getElementById('result').scrollIntoView({behavior: 'smooth'});
        }
        
        function formatText(text) {
            if (!text) return '';
            // Handle markdown-style basic formatting
            let formatted = text
                .replace(/^# (.*$)/gim, '<h1>$1</h1>') // H1
                .replace(/^## (.*$)/gim, '<h2>$1</h2>') // H2
                .replace(/^### (.*$)/gim, '<h3>$1</h3>') // H3
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                .replace(/\n\n/g, '<br><br>'); // Paragraphs
                
            return formatted;
        }
        
        function showError(msg) {
            const contentDiv = document.getElementById('result-content');
            contentDiv.innerHTML = `<div class="result-card" style="border-left: 4px solid #f44336; background: #ffebee;">${msg}</div>`;
            document.getElementById('result').style.display = 'block';
        }
    </script>
</body>
</html>