events {
    worker_connections 1024;
}

http {
    upstream sum_simple {
        server sum-simple:3000;
    }

    upstream sum_intelligence {
        server sum-intelligence:3001;
    }

    # For gradual rollout - start with old version getting most traffic
    map $request_uri $backend_pool {
        ~^/api/v2/  sum_intelligence;  # New endpoints go to intelligence layer
        default     sum_simple;         # Everything else to simple version
    }

    server {
        listen 80;
        server_name localhost;

        # Enable gzip compression
        gzip on;
        gzip_types text/plain application/json;

        # Basic rate limiting
        limit_req_zone $binary_remote_addr zone=api_limit:10m rate=60r/m;
        limit_req zone=api_limit burst=10 nodelay;

        # Proxy settings
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Health check endpoint
        location /health {
            proxy_pass http://sum_simple;
        }

        # Stats endpoint
        location /stats {
            proxy_pass http://sum_simple;
        }

        # Main summarize endpoint with A/B testing
        location /summarize {
            # A/B testing - gradually increase traffic to new version
            set $backend sum_simple;
            
            # Random number for A/B testing (0-99)
            set_random $random_number 0 100;
            
            # Start with 1% to new version, increase over time
            # Week 1: 1%
            # Week 2: 10%
            # Week 3: 50%
            # Week 4: 100%
            if ($random_number < 1) {  # Change this number to control rollout
                set $backend sum_intelligence;
            }
            
            # Add header to track which version served the request
            add_header X-Served-By $backend;
            
            proxy_pass http://$backend;
        }

        # New v2 endpoints go directly to intelligence layer
        location /api/v2/ {
            proxy_pass http://sum_intelligence;
        }

        # Default location
        location / {
            proxy_pass http://$backend_pool;
        }

        # Custom error pages
        error_page 502 503 504 /50x.json;
        location = /50x.json {
            return 503 '{"error": "Service temporarily unavailable", "message": "Please try again later"}';
            add_header Content-Type application/json;
        }
    }
}